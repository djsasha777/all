<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SMARTHOME</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      background-color: #fff;
    }
    button {
      display: block;
      width: 80vw;
      max-width: 300px;
      padding: 15px;
      font-size: 1.5em;
      background-color: #5e9ca0;
      color: white;
      border: none;
      outline: none;
      cursor: pointer;
      margin-bottom: 20px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2e6c80;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    div#responseDiv, div.response-div {
      text-align: center;
      font-size: 1.2em;
      color: #5e9ca0;
      margin-bottom: 15px;
    }
    #login-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
    }
    #login-section.hidden {
      display: none;
    }
    #login-form {
      background: white;
      color: black;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 300px;
      width: 90%;
    }
    #login-form input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1.1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #login-form button {
      width: 100%;
      margin-top: 15px;
    }
    .save-password {
      margin: 10px 0;
      display: flex;
      align-items: center;
      font-size: 0.9em;
    }
    .save-password input {
      width: auto;
      margin-right: 8px;
    }
    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #5e9ca0;
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 0.9em;
      z-index: 999;
    }
    ul {
      list-style-type: none;
      padding: 0;
      margin-top: 100px;
    }
    li {
      margin-bottom: 15px;
    }
  </style>
  <script>
    // Встроенный манифест PWA
    const manifest = {
      name: "SPONGO HOME",
      short_name: "SPONGO",
      start_url: ".",
      display: "standalone",
      background_color: "#fff",
      theme_color: "#5e9ca0",
      description: "SPONGO HOME PWA",
      icons: [
        { src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6Q...", sizes: "192x192", type: "image/png" },
        { src: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAAA1BMVEUAAACnej3aAAAASElEQVQ4y2NgGAWjYBSMglEwCkbBtoX39wAAAABJRU5ErkJggg==", sizes: "512x512", type: "image/png" }
      ]
    };

    // Функция внедрения манифеста
    function injectManifest() {
      const stringManifest = JSON.stringify(manifest);
      const blob = new Blob([stringManifest], { type: "application/json" });
      const manifestURL = URL.createObjectURL(blob);
      const linkElem = document.createElement("link");
      linkElem.rel = "manifest";
      linkElem.href = manifestURL;
      document.head.appendChild(linkElem);
    }

    // Улучшенный Service Worker с поддержкой credentials
    const swCode = `
      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open('spongo-cache-v2').then(cache => {
            return cache.addAll([
              '/'
            ].map(url => new Request(url, {credentials: 'include'})));
          })
        );
      });

      self.addEventListener('fetch', event => {
        if (event.request.url.includes('/on') || 
            event.request.url.includes('/off') || 
            event.request.url.includes('/long')) {
          // Пропускаем прокси-запросы без кеширования
          return fetch(event.request);
        }
        event.respondWith(
          caches.match(event.request).then(response => {
            return response || fetch(event.request);
          })
        );
      });
    `;

    // Регистрация Service Worker
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        const blob = new Blob([swCode], { type: "application/javascript" });
        const swURL = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swURL, { updateViaCache: 'none' })
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.error('Service Worker error:', err));
      }
    }

    // Глобальные переменные для credentials
    let credentials = null;
    let isAuthenticated = false;

    // Сохранение credentials в localStorage
    function saveCredentials(username, password, savePassword) {
      const authData = btoa(`${username}:${password}`);
      credentials = `Basic ${authData}`;
      
      if (savePassword) {
        localStorage.setItem('spongo_auth_username', username);
        localStorage.setItem('spongo_auth_password', password);
        localStorage.setItem('spongo_auth_save', 'true');
      } else {
        sessionStorage.setItem('spongo_auth_username', username);
        sessionStorage.setItem('spongo_auth_password', password);
      }
    }

    // Загрузка сохраненных credentials
    function loadSavedCredentials() {
      const savedUsername = localStorage.getItem('spongo_auth_username') || 
                           sessionStorage.getItem('spongo_auth_username');
      const savedPassword = localStorage.getItem('spongo_auth_password') || 
                           sessionStorage.getItem('spongo_auth_password');
      
      if (savedUsername && savedPassword) {
        credentials = `Basic ${btoa(`${savedUsername}:${savedPassword}`)}`;
        return { username: savedUsername, password: savedPassword };
      }
      return null;
    }

    // Проверка аутентификации
    async function testAuth() {
      try {
        const response = await fetch('https://home.spongo.ru/on', {
          method: 'HEAD',
          headers: credentials ? { 'Authorization': credentials } : {},
          credentials: 'include'
        });
        return response.ok;
      } catch {
        return false;
      }
    }

    // Автологин при загрузке
    async function tryAutoLogin() {
      const saved = loadSavedCredentials();
      if (saved) {
        const authOk = await testAuth();
        if (authOk) {
          isAuthenticated = true;
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById('status').textContent = `Авторизован как: ${saved.username}`;
          initButtons();
          return true;
        }
      }
      return false;
    }

    // Инициализация кнопок с авторизацией
    function initButtons() {
      const buttonConfigs = [
        { id: "serverON", endpoint: "https://home.spongo.ru/on", message: "SERVER ON" },
        { id: "serverLONG", endpoint: "https://home.spongo.ru/long", message: "SERVER LONG" },
        { id: "server1_ON", endpoint: "https://home.spongo.ru/1on", message: "SERVER1 ON" },
        { id: "server1_OFF", endpoint: "https://home.spongo.ru/1off", message: "SERVER1 OFF" },
        { id: "server2_ON", endpoint: "https://home.spongo.ru/2on", message: "SERVER2 ON" },
        { id: "server2_OFF", endpoint: "https://home.spongo.ru/2off", message: "SERVER2 OFF" },
        { id: "server3_ON", endpoint: "https://home.spongo.ru/3on", message: "SERVER3 ON" },
        { id: "server3_OFF", endpoint: "https://home.spongo.ru/3off", message: "SERVER3 OFF" }
      ];

      buttonConfigs.forEach(config => {
        const button = document.getElementById(config.id);
        const responseDiv = document.querySelector(`[data-response="${config.id}"]`) || 
                           document.getElementById(`responseDiv${buttonConfigs.indexOf(config) + 1}`);
        
        button.disabled = false;
        button.onclick = makeButtonHandler(config.endpoint, config.message, responseDiv);
      });
    }

    // Универсальный обработчик кнопок
    function makeButtonHandler(endpoint, successMessage, responseDiv) {
      return async function() {
        const button = event.target;
        button.disabled = true;
        responseDiv.innerText = 'Отправка...';

        try {
          const response = await fetch(endpoint, {
            method: 'GET',
            headers: credentials ? { 
              'Authorization': credentials,
              'Cache-Control': 'no-cache'
            } : {},
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          await response.text();
          responseDiv.innerText = successMessage;
          setTimeout(() => responseDiv.innerText = '', 3000);
        } catch(error) {
          console.error('Ошибка:', error);
          responseDiv.innerText = `Ошибка: ${error.message}`;
          setTimeout(() => responseDiv.innerText = '', 5000);
        } finally {
          button.disabled = false;
        }
      };
    }

    // Обработчик формы логина
    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const savePassword = document.getElementById('save-password').checked;

      if (!username || !password) {
        alert('Введите логин и пароль');
        return;
      }

      saveCredentials(username, password, savePassword);
      
      const authOk = await testAuth();
      if (authOk) {
        isAuthenticated = true;
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('status').textContent = `Авторизован как: ${username}`;
        initButtons();
      } else {
        alert('Неверный логин или пароль');
        credentials = null;
      }
    }

    // Выход из аккаунта
    function logout() {
      credentials = null;
      isAuthenticated = false;
      localStorage.removeItem('spongo_auth_username');
      localStorage.removeItem('spongo_auth_password');
      localStorage.removeItem('spongo_auth_save');
      sessionStorage.clear();
      document.getElementById('login-section').classList.remove('hidden');
      document.querySelectorAll('button:not(#login-btn)').forEach(btn => {
        btn.disabled = true;
      });
    }

    // Инициализация при загрузке
    window.addEventListener('load', async () => {
      injectManifest();
      registerServiceWorker();
      
      // Показываем статус
      const statusDiv = document.createElement('div');
      statusDiv.id = 'status';
      statusDiv.textContent = 'Загрузка...';
      document.body.appendChild(statusDiv);

      // Пробуем автологин
      const autoLoginSuccess = await tryAutoLogin();
      if (!autoLoginSuccess) {
        document.getElementById('login-section').classList.remove('hidden');
      }

      // Обработчик кнопки выхода (добавьте кнопку в HTML если нужно)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isAuthenticated) {
          logout();
        }
      });
    });
  </script>
</head>
<body>
  <!-- Экран логина -->
  <div id="login-section">
    <form id="login-form" onsubmit="handleLogin(event)">
      <h2>Вход в SMARTHOME</h2>
      <input type="text" id="username" placeholder="Логин" required />
      <input type="password" id="password" placeholder="Пароль" required />
      <label class="save-password">
        <input type="checkbox" id="save-password" checked />
        Запомнить пароль
      </label>
      <button type="submit" id="login-btn">Войти</button>
    </form>
  </div>

  <!-- Основной интерфейс -->
  <ul>
    <li>
      <button id="serverON" disabled>SERVER ON</button>
      <div class="response-div" data-response="serverON"></div>
    </li>
    <li>
      <button id="serverLONG" disabled>SERVER LONG</button>
      <div class="response-div" data-response="serverLONG"></div>
    </li>
    <li>
      <button id="server1_ON" disabled>SERVER1 ON</button>
      <div class="response-div" data-response="server1_ON"></div>
    </li>
    <li>
      <button id="server1_OFF" disabled>SERVER1 OFF</button>
      <div class="response-div" data-response="server1_OFF"></div>
    </li>
    <li>
      <button id="server2_ON" disabled>SERVER2 ON</button>
      <div class="response-div" data-response="server2_ON"></div>
    </li>
    <li>
      <button id="server2_OFF" disabled>SERVER2 OFF</button>
      <div class="response-div" data-response="server2_OFF"></div>
    </li>
    <li>
      <button id="server3_ON" disabled>SERVER3 ON</button>
      <div class="response-div" data-response="server3_ON"></div>
    </li>
    <li>
      <button id="server3_OFF" disabled>SERVER3 OFF</button>
      <div class="response-div" data-response="server3_OFF"></div>
    </li>
  </ul>
</body>
</html>

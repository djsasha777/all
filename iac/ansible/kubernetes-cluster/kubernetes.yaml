---
- name: Подготовка хостов и установка containerd + Kubernetes
  hosts: all
  become: true
  gather_facts: true
  vars_prompt:
    - name: "control_plane_endpoint"
      prompt: "Control Plane endpoint (по умолчанию {{ groups['kube-master'][0] }}): "
      private: false
      default: "{{ groups['kube-master'][0] }}"

  pre_tasks:
    - name: Проверка ОС
      ansible.builtin.assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: "Поддерживается только Debian/Ubuntu"

  tasks:
    - name: Обновление системы
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        cache_valid_time: 3600

    - name: Установка базовых пакетов
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - iproute2
          - net-tools
          - conntrack
          - systemd
          - jq
        state: present

    # Containerd установка
    - name: Создание директории keyrings
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Добавление GPG ключа Docker
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Добавление Docker/containerd репозитория
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Установка containerd
      ansible.builtin.apt:
        name: containerd.io={{ containerd_version }}
        state: present
        update_cache: true

    - name: Остановка containerd сервиса
      ansible.builtin.systemd:
        name: containerd
        state: stopped

    - name: Создание конфигурации containerd
      ansible.builtin.copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_config }}"
      notify: restart containerd

    - name: Генерация default config (если нужно)
      ansible.builtin.command:
        cmd: containerd config default > /tmp/config.toml
        creates: /tmp/config.toml
      when: containerd_config == ""

    - name: Запуск containerd
      ansible.builtin.systemd:
        name: containerd
        state: started
        enabled: true

    # Отключение swap
    - name: Отключение swap
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - swap.target
        - swapfile.swap

    - name: Отключение swap в fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '^.*swap.*$'
        state: absent

    # Модули ядра и sysctl
    - name: Загрузка модулей ядра
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
      notify: load kernel modules

    - name: Настройка sysctl для Kubernetes
      ansible.builtin.copy:
        dest: /etc/sysctl.d/99-kubernetes.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        notify: apply sysctl

    # Kubernetes репозиторий
    - name: Добавление репозитория Kubernetes
      ansible.builtin.apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version.split('-')[0] }}/deb/ /"
        state: present
        filename: kubernetes

    - name: Добавление GPG ключа Kubernetes
      ansible.builtin.get_url:
        url: "https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version.split('-')[0] }}/deb/Release.key"
        dest: /etc/apt/trusted.gpg.d/kubernetes.gpg
        mode: '0644'

    - name: Установка CRI tools
      ansible.builtin.apt:
        name: cri-tools
        state: present
        update_cache: true

    - name: Установка Kubernetes компонентов
      ansible.builtin.apt:
        name:
          - kubelet={{ kubernetes_version }}
          - kubeadm={{ kubernetes_version }}
          - kubectl={{ kubernetes_version }}
        state: present
        update_cache: true

    - name: Держать версии Kubernetes и containerd
      ansible.builtin.apt-mark:
        mark: hold
        packages:
          - kubelet
          - kubeadm
          - kubectl
          - containerd.io

    - name: Настройка kubelet для containerd
      ansible.builtin.lineinfile:
        path: /var/lib/kubelet/config.yaml
        create: true
        line: |
          apiVersion: kubelet.config.k8s.io/v1beta1
          kind: KubeletConfiguration
          containerRuntimeEndpoint: unix:///run/containerd/containerd.sock
      notify: restart kubelet

  handlers:
    - name: load kernel modules
      ansible.builtin.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: apply sysctl
      ansible.builtin.sysctl:
        name: "{{ item }}"
        value: "1"
        state: present
        sysctl_set: true
        reload: true
      loop:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables
        - net.ipv4.ip_forward

    - name: restart containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        daemon_reload: true

    - name: restart kubelet
      ansible.builtin.systemd:
        name: kubelet
        state: restarted
        daemon_reload: true

---
- name: Инициализация первого мастера
  hosts: kube-master[0]
  become: true
  tasks:
    - name: Создание kubeadm config
      ansible.builtin.copy:
        dest: /etc/kubernetes/kubeadm-config.yaml
        content: "{{ kubeadm_config_template }}"

    - name: Инициализация кластера
      ansible.builtin.command:
        cmd: kubeadm init --config /etc/kubernetes/kubeadm-config.yaml --upload-certs
        creates: /etc/kubernetes/admin.conf
      register: kubeadm_init

    - name: Создание .kube директории
      ansible.builtin.file:
        path: /root/.kube
        state: directory

    - name: Копирование admin.conf
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true

    - name: Сохранение join команд
      ansible.builtin.shell: |
        kubeadm token create --print-join-command > /tmp/worker-join-command
        kubeadm token create --certificate-key $(kubeadm init phase upload-certs --upload-certs | tail -1) --print-join-command --control-plane > /tmp/controlplane-join-command
      args:
        creates: /tmp/worker-join-command

---
- name: Установка kube-vip для HA Control Plane
  hosts: kube-master
  become: true
  tasks:
    - name: Скачивание kube-vip
      ansible.builtin.get_url:
        url: "https://github.com/kube-vip/kube-vip/releases/download/v{{ kube_vip_version }}/kube-vip_linux_amd64.tar.gz"
        dest: /tmp/kube-vip.tar.gz

    - name: Распаковка kube-vip
      ansible.builtin.unarchive:
        src: /tmp/kube-vip.tar.gz
        dest: /usr/local/bin/
        remote_src: true
        mode: '0755'

    - name: Создание ServiceAccount для kube-vip
      ansible.builtin.kubectl:
        name: kube-vip
        namespace: kube-system
        api_version: v1
        kind: ServiceAccount
        state: present
        kubeconfig: /root/.kube/config
      when: inventory_hostname == groups['kube-master'][0]

    - name: Создание ClusterRoleBinding для kube-vip
      ansible.builtin.kubectl:
        name: kube-vip
        api_version: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        definition:
          metadata:
            name: kube-vip
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - kind: ServiceAccount
            name: kube-vip
            namespace: kube-system
        state: present
        kubeconfig: /root/.kube/config
      when: inventory_hostname == groups['kube-master'][0]

    - name: Создание kube-vip DaemonSet
      ansible.builtin.kubectl:
        name: kube-vip-ds
        namespace: kube-system
        definition:
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: kube-vip-ds
            namespace: kube-system
          spec:
            selector:
              matchLabels:
                name: kube-vip-ds
            template:
              metadata:
                labels:
                  name: kube-vip-ds
              spec:
                serviceAccountName: kube-vip
                containers:
                - name: kube-vip
                  image: ghcr.io/kube-vip/kube-vip:v{{ kube_vip_version }}
                  args:
                  - manager
                  securityContext:
                    capabilities:
                      add:
                      - NET_ADMIN
                      - NET_RAW
                  env:
                  - name: interface
                    value: "{{ kube_vip_interface }}"
                  - name: vip_arp
                    value: "true"
                  - name: address
                    value: "{{ control_plane_endpoint }}"
                  - name: port
                    value: "6443"
                  - name: controlplane
                    value: "true"
                  - name: cp_enable
                    value: "true"
                  - name: cp_namespace
                    value: kube-system
                  volumeMounts:
                  - mountPath: /etc/kubernetes/admin.conf
                    name: kubeconfig
                    readOnly: true
                volumes:
                - name: kubeconfig
                  hostPath:
                    path: /etc/kubernetes/admin.conf
        kubeconfig: /root/.kube/config
      when: inventory_hostname == groups['kube-master'][0]

---
- name: Присоединение остальных мастеров
  hosts: kube-master[1:]
  become: true
  tasks:
    - name: Получение control-plane join команды
      ansible.builtin.slurp:
        src: /tmp/controlplane-join-command
      register: cp_join_file
      delegate_to: "{{ groups['kube-master'][0] }}"

    - name: Выполнение control-plane join
      ansible.builtin.shell: "{{ (cp_join_file.content | b64decode).strip() }}"

    - name: Копирование admin.conf
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: true

---
- name: Присоединение воркеров (мастера уже воркеры)
  hosts: kube-node
  become: true
  tasks:
    - name: Получение worker join команды
      ansible.builtin.slurp:
        src: /tmp/worker-join-command
      register: worker_join_file
      delegate_to: "{{ groups['kube-master'][0] }}"

    - name: Пропуск для мастеров
      ansible.builtin.meta: end_host
      when: inventory_hostname in groups['kube-master']

    - name: Выполнение worker join
      ansible.builtin.shell: "{{ (worker_join_file.content | b64decode).strip() }}"

---
- name: Установка Cilium (замена kube-proxy)
  hosts: kube-master[0]
  become: true
  tasks:
    - name: Установка Helm
      ansible.builtin.get_url:
        url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
        dest: /tmp/helm.tar.gz

    - name: Распаковка Helm
      ansible.builtin.unarchive:
        src: /tmp/helm.tar.gz
        dest: /tmp/
        remote_src: true

    - name: Перемещение Helm бинарника
      ansible.builtin.copy:
        src: /tmp/linux-amd64/helm
        dest: /usr/local/bin/helm
        remote_src: true
        mode: '0755'

    - name: Добавление Cilium Helm репозитория
      ansible.builtin.shell:
        cmd: helm repo add cilium https://helm.cilium.io/ && helm repo update

    - name: Удаление kube-proxy
      ansible.builtin.kubectl:
        name: kube-proxy
        namespace: kube-system
        kind: DaemonSet
        state: absent
        kubeconfig: /root/.kube/config

    - name: Установка Cilium с kube-proxy replacement
      ansible.builtin.shell:
        cmd: |
          helm upgrade --install cilium cilium/cilium \
            --version {{ cilium_version }} \
            --namespace kube-system \
            --set kubeProxyReplacement=true \
            --set kubeProxyReplacement.helmConfig.kubeProxy.selector.kubeProxyReplacement=strict \
            --set ipam.mode=kubernetes \
            --set operator.replicaCount=1 \
            --set hubble.enabled=false \
            --set k8sServiceHost={{ control_plane_endpoint }} \
            --set k8sServicePort=6443 \
            --create-namespace
        kubeconfig: /root/.kube/config

    - name: Проверка Cilium pods
      ansible.builtin.kubectl:
        arguments: get pods -n kube-system -l k8s-app=cilium
        kubeconfig: /root/.kube/config

    - name: Сохранение cluster info
      ansible.builtin.copy:
        content: |
          Cluster: {{ cluster_name }}
          Control Plane: {{ control_plane_endpoint }}
          Pod CIDR: {{ pod_cidr }}
          K8s Version: {{ kubernetes_version }}
          Cilium Version: {{ cilium_version }}
          Containerd Version: {{ containerd_version }}
        dest: /root/cluster-info.txt
